<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hati Tenang - Ruang untuk Ceritamu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .chat-bubble { max-width: 75%; padding: 12px 16px; border-radius: 20px; word-wrap: break-word; }
        .user-bubble { background-color: #3B82F6; color: white; border-bottom-right-radius: 4px; align-self: flex-end; }
        .ai-bubble { background-color: #E5E7EB; color: #1F2937; border-bottom-left-radius: 4px; align-self: flex-start; }
        .recommendation-card { background-color: #FFFBEB; border: 1px solid #FBBF24; }
        .stress-bar-bg { background-color: #E5E7EB; border-radius: 9999px; overflow: hidden; }
        .stress-bar-fill { height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out; }
        .thinking-bubble { align-self: flex-start; }
        .dot-flashing { position: relative; width: 10px; height: 10px; border-radius: 5px; background-color: #9880ff; color: #9880ff; animation: dotFlashing 1s infinite linear alternate; animation-delay: .5s; }
        .dot-flashing::before, .dot-flashing::after { content: ''; display: inline-block; position: absolute; top: 0; }
        .dot-flashing::before { left: -15px; width: 10px; height: 10px; border-radius: 5px; background-color: #9880ff; color: #9880ff; animation: dotFlashing 1s infinite alternate; animation-delay: 0s; }
        .dot-flashing::after { left: 15px; width: 10px; height: 10px; border-radius: 5px; background-color: #9880ff; color: #9880ff; animation: dotFlashing 1s infinite alternate; animation-delay: 1s; }
        @keyframes dotFlashing { 0% { background-color: #A8A29E; } 50%, 100% { background-color: #D6D3D1; } }
    </style>
</head>
<body class="bg-blue-50 text-gray-800">

    <!-- Landing Page Section -->
    <div id="landing-page" class="flex flex-col items-center justify-center min-h-screen p-6 text-center transition-opacity duration-500">
        <div class="max-w-2xl">
            <svg class="w-24 h-24 mx-auto text-blue-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path></svg>
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900">Selamat Datang di <span class="text-blue-600">Hati Tenang</span></h1>
            <p class="mt-4 text-lg text-gray-600">Ada ruang aman untuk setiap ceritamu. Kami di sini untuk mendengarkan tanpa menghakimi. Tarik napas, dan mulailah saat kamu siap.</p>
            <button id="start-chat-btn" class="mt-8 px-8 py-4 bg-blue-600 text-white font-semibold rounded-full shadow-lg hover:bg-blue-700 transform hover:scale-105 transition-transform duration-300">
                Mulai Curhat Sekarang
            </button>
            <p class="mt-4 text-sm text-gray-500">Percakapanmu 100% anonim dan rahasia.</p>
        </div>
    </div>

    <!-- Chat Page Section -->
    <div id="chat-page" class="hidden flex-col h-screen max-w-3xl mx-auto bg-white shadow-2xl transition-opacity duration-500">
        <header class="p-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path></svg>
                    <div class="ml-3">
                        <h2 class="text-lg font-semibold text-gray-900">Teman Cerita AI</h2>
                        <p class="text-sm text-green-500">Online</p>
                    </div>
                </div>
                <div class="w-1/3">
                    <p class="text-xs text-gray-500 mb-1 text-right" id="stress-level-text">Tingkat Stres: Rendah</p>
                    <div class="stress-bar-bg h-2.5">
                        <div id="stress-bar" class="stress-bar-fill bg-green-500" style="width: 10%;"></div>
                    </div>
                </div>
            </div>
        </header>

        <main id="chat-area" class="flex-1 p-6 overflow-y-auto flex flex-col space-y-4">
            <!-- Chat messages will be appended here -->
        </main>

        <footer class="p-4 border-t border-gray-200">
            <div class="flex items-center">
                <input type="text" id="chat-input" placeholder="Ketik ceritamu di sini..." class="w-full px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                <button id="send-btn" class="ml-3 p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 focus:outline-none" disabled>
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </button>
            </div>
        </footer>
    </div>

    <script>
        // DOM Elements and State
        const landingPage = document.getElementById('landing-page');
        const chatPage = document.getElementById('chat-page');
        const startChatBtn = document.getElementById('start-chat-btn');
        const chatArea = document.getElementById('chat-area');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const stressBar = document.getElementById('stress-bar');
        const stressLevelText = document.getElementById('stress-level-text');

        let currentStressScore = 0;
        const MAX_STRESS_SCORE = 100;
        let chatHistory = [];

        // --- UI Functions ---
        startChatBtn.addEventListener('click', () => {
            landingPage.classList.add('opacity-0');
            setTimeout(() => {
                landingPage.classList.add('hidden');
                chatPage.classList.remove('hidden');
                chatPage.classList.add('flex');
                chatInput.disabled = false;
                sendBtn.disabled = false;
                // Add initial AI message to history and UI
                const initialMessage = "Halo, saya di sini untuk mendengarkan. Apa yang sedang kamu rasakan atau pikirkan saat ini?";
                addChatBubble(initialMessage, 'ai');
                chatHistory.push({ role: 'model', parts: initialMessage });
                setTimeout(() => chatPage.classList.remove('opacity-0'), 50);
            }, 500);
        });

        function addChatBubble(message, sender) {
            const bubble = document.createElement('div');
            bubble.classList.add('chat-bubble', sender === 'user' ? 'user-bubble' : 'ai-bubble');
            bubble.textContent = message;
            chatArea.appendChild(bubble);
            chatArea.scrollTop = chatArea.scrollHeight;
        }
        
        function showThinkingIndicator() {
            const thinkingBubble = document.createElement('div');
            thinkingBubble.id = 'thinking-indicator';
            thinkingBubble.classList.add('chat-bubble', 'ai-bubble', 'thinking-bubble');
            thinkingBubble.innerHTML = `<div class="dot-flashing"></div>`;
            chatArea.appendChild(thinkingBubble);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function removeThinkingIndicator() {
            const indicator = document.getElementById('thinking-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function updateStressIndicator() {
            const percentage = Math.min((currentStressScore / MAX_STRESS_SCORE) * 100, 100);
            stressBar.style.width = `${percentage}%`;
            if (currentStressScore < 40) {
                stressLevelText.textContent = 'Tingkat Stres: Rendah';
                stressBar.className = 'stress-bar-fill bg-green-500';
            } else if (currentStressScore < 75) {
                stressLevelText.textContent = 'Tingkat Stres: Sedang';
                stressBar.className = 'stress-bar-fill bg-yellow-500';
            } else {
                stressLevelText.textContent = 'Tingkat Stres: Tinggi';
                stressBar.className = 'stress-bar-fill bg-red-500';
            }
        }
        
        function showRecommendation() {
            const card = document.createElement('div');
            card.classList.add('p-4', 'rounded-lg', 'mt-2', 'recommendation-card');
            card.innerHTML = `<h3 class="font-bold text-yellow-800">Bantuan Profesional Tersedia</h3><p class="text-sm text-yellow-700 mt-1">Jika kamu merasa butuh bantuan lebih lanjut, jangan ragu untuk menghubungi para ahli. Kesehatan mentalmu adalah prioritas.</p><a href="#" class="mt-3 inline-block bg-yellow-400 text-yellow-900 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-yellow-500">Lihat Opsi Bantuan</a>`;
            chatArea.appendChild(card);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // --- API Communication ---
        const API_BASE_URL = 'http://localhost:3000';

        async function getAIStressAnalysis(message) {
            const response = await fetch(`${API_BASE_URL}/analyze-stress`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message })
            });
            if (!response.ok) throw new Error('Gagal menganalisis stres');
            return response.json();
        }

        async function getAIConversationalResponse(history, stressScore) {
            const response = await fetch(`${API_BASE_URL}/generate-response`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chatHistory: history, currentStressScore: stressScore })
            });
            if (!response.ok) throw new Error('Gagal menghasilkan balasan');
            return response.json();
        }

        // --- Main Chat Function ---
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (message === '') return;

            addChatBubble(message, 'user');
            chatHistory.push({ role: 'user', parts: message });
            chatInput.value = '';
            chatInput.disabled = true;
            sendBtn.disabled = true;
            showThinkingIndicator();

            try {
                // 1. Dapatkan analisis stres
                const analysis = await getAIStressAnalysis(message);
                currentStressScore += analysis.stressScore;
                updateStressIndicator();
                
                // 2. Dapatkan balasan percakapan
                const conversationalResponse = await getAIConversationalResponse(chatHistory, currentStressScore);
                removeThinkingIndicator();
                addChatBubble(conversationalResponse.message, 'ai');
                chatHistory.push({ role: 'model', parts: conversationalResponse.message });

                // 3. Tampilkan kartu rekomendasi jika perlu
                if (conversationalResponse.type === 'escalation') {
                    setTimeout(showRecommendation, 1000);
                }
            } catch (error) {
                console.error("Error:", error);
                removeThinkingIndicator();
                addChatBubble("Maaf, sepertinya ada sedikit gangguan. Coba lagi beberapa saat ya.", 'ai');
            } finally {
                chatInput.disabled = false;
                sendBtn.disabled = false;
                chatInput.focus();
            }
        }

        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        
        updateStressIndicator();
    </script>
</body>
</html>